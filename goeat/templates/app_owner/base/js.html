{% load static %}
{% load hosts %}

<script>
  const showpage = 'showpage_container';

  var _list_id = ''; //선택한 주문 id
  var _reason = ''; //취소 or 거절 사유
  var _elem = ''; // [예약] 선택한 list elem
  var _reject_array = [];
  var _complete_arrary = [];

  var eventify = function (arr, callback) {
    arr.push = function (e) {
      Array.prototype.push.call(arr, e);
      callback(arr.shift());
    };
  };

  // setInterval clear
  function intervalClear() {
    clearInterval(interval1);
    clearInterval(interval2);
  }

  // 예약관리
  async function reserve() {
    let result = await DomCallback("{% host_url 'reserve' host 'owner' %}", {});
    if (result.result) {
      allHide();
      show('reserve', result);
    }
  }

  // 스탬프관리
  async function stamp() {
    intervalClear();

    let result = await DomCallback("{% host_url 'stamp' host 'owner' %}", {});
    if (result.result) {
      allHide();
      show('stamp', result);
    }
  }

  // 쿠폰관리
  async function coupon() {
    intervalClear();

    let result = await DomCallback("{% host_url 'coupon' host 'owner' %}", {});
    if (result.result) {
      allHide();
      show('coupon', result);
    }
  }

  // 가게관리
  async function setting() {
    intervalClear();

    let result = await DomCallback("{% host_url 'setting' host 'owner' %}", {});
    if (result.result) {
      allHide();
      show('setting', result);
      onToggleReserve()
    }
  }


  /* ================= modal ================= */

  async function reserveReject(elem, list_id) {

    _list_id = list_id;
    _elem = elem;

    let result = await DomCallback("{% host_url 'reserve_reject' host 'owner' %}", {});
    if (result.result) {
      modalShow('예약 거절 사유 선택', result);
    }
  }


  async function reserveCancel(elem, list_id) {

    _list_id = list_id;
    _elem = elem;

    let result = await DomCallback("{% host_url 'reserve_cancel' host 'owner' %}", {});
    if (result.result) {
      modalShow('예약 취소 사유 선택', result);
    }
  }

  async function stampApply() {
    let result = await DomCallback("{% host_url 'stamp_apply' host 'owner' %}", {});
    if (result.result) {
      modalShow('스탬프 적립 신청 내역', result);
    }
  }

  async function stampSaving() {
    let result = await DomCallback("{% host_url 'stamp_saving' host 'owner' %}", {});
    if (result.result) {
      modalShow('스탬프 적립하기', result);
    }
  }

  async function couponApply() {
    let result = await DomCallback("{% host_url 'coupon_apply' host 'owner' %}", {});
    if (result.result) {
      modalShow('쿠폰 적립 신청 내역', result);
    }
  }

  async function couponUse() {
    let result = await DomCallback("{% host_url 'coupon_use' host 'owner' %}", {});
    if (result.result) {
      modalShow('쿠폰 사용 요청', result);
    }
  }

  async function couponSidemenu() {
    let result = await DomCallback("{% host_url 'coupon_sidemenu' host 'owner' %}", {});
    if (result.result) {
      modalShow("사이드 메뉴", result);
    }
  }
  async function couponDiscount() {
    let result = await DomCallback("{% host_url 'coupon_discount' host 'owner' %}", {});
    if (result.result) {
      modalShow("할인 쿠폰", result);
    }
  }


  async function settingTime() {
    let result = await DomCallback("{% host_url 'setting_time' host 'owner' %}", {});
    if (result.result) {
      modalShow('시간 변경', result);
    }
  }

  async function settingNotice(notice_id) {
    let result = await DomCallback("{% host_url 'setting_notice' host 'owner' %}", {
      'notice_id': notice_id
    });
    if (result.result) {
      modalShow('고잇 공지사항', result);
    }
  }

  /* ================= toggle function ================= */

  function onClickToggle(el) {

    $(el).css('point-events', 'none');

    var is_toggle = true;

    if ($(el).hasClass('on')) {

      $(el).removeClass('on');
      is_toggle = false;

    }
    else $(el).addClass('on');

    is_reserve(is_toggle);

    $(el).css('point-events', 'default');
  }

  /* ================= spa function ================= */

  const DomCallback = function (url, params) {

    showLoading();

    params['csrfmiddlewaretoken'] = '{{ csrf_token }}'

    return new Promise((result) => {

      $.ajax({
        url: url,
        type: "POST",
        data: params,
        success: (data) => {
          result({
            'result': true,
            'msg': '',
            'data': data
          });
        },
        error: (data) => {

          alert('서버와 접속이 원활하지 않습니다.');

          result({
            'result': false,
            'msg': '',
            'data': data
          });

          hideLoading();
        }
      });
    });
  }

  function show(id, result) {
    try {
      $('.content_box').append(`<div class="${showpage}" id="${id}"></div>`);
      $(`#${id}`).html(result.data);

      setTimeout(() => {
        $(`.${showpage}`).addClass('on');
        hideLoading();
      }, 10)
      onActiveNav(id);
    }
    catch (error) {
      alert('서버와 연결이 끊어졌습니다.');
      hideLoading();
    }

  }

  function hide(id) {
    try {
      $(`#${id}`).remove();
    } catch (error) {
      alert('서버와 연결이 끊어졌습니다.');
      hideLoading();
    }
  }

  function allHide() {
    try {
      $(`.${showpage}`).remove();
      $('.gj-modal').remove();
      // $('.gj-picker').remove();
    } catch (error) {
      alert('서버와 연결이 끊어졌습니다.');
      hideLoading();
    }
  }


  function lastHide() {
    try {
      $(`.${showpage}`).eq(-1).remove();
    } catch (error) {
      alert('서버와 연결이 끊어졌습니다.');
      hideLoading();
    }
  }


  function modalShow(title, result) {
    try {
      $('.modal_content').html(result.data);
      $('.modal_container').addClass('on');
      $('.modal_title').html(title);
      hideLoading();
    }
    catch (error) {
      alert('서버와 연결이 끊어졌습니다.');
      hideLoading();
    }
  }
  function modalClose() {
    $('.modal_container').removeClass('on');
  }


  function showLoading() {
    $('body').append(`
      <div class="loading_bg">
        <div class="spinner"></div>
      </div>
    `)
  }

  function hideLoading() {
    $('.loading_bg').remove();
  }

  function onActiveNav(navId) {
    $('.side_nav_item').removeClass('on');
    $(`#${navId}_nav`).addClass('on');
  }

  function hideNav() {
    $('.side_nav').addClass('disable');
    $('.nav_header').addClass('disable');
    $('.content_box').addClass('on');
  }

  function showNav() {
    $('.side_nav').removeClass('disable');
    $('.nav_header').removeClass('disable');
    $('.content_box').removeClass('on');
  }


  var docV = document.documentElement;
  // 전체화면 설정
  function openFullScreenMode() {
    if (docV.requestFullscreen)
      docV.requestFullscreen();
    else if (docV.webkitRequestFullscreen) // Chrome, Safari (webkit)
      docV.webkitRequestFullscreen();
    else if (docV.mozRequestFullScreen) // Firefox
      docV.mozRequestFullScreen();
    else if (docV.msRequestFullscreen) // IE or Edge
      docV.msRequestFullscreen();
  }

  function close_frm() {

    closefrm.call();

  }

  // 전체화면 해제
  function closeFullScreenMode() {
    if (document.exitFullscreen)
      document.exitFullscreen();
    else if (document.webkitExitFullscreen) // Chrome, Safari (webkit)
      document.webkitExitFullscreen();
    else if (document.mozCancelFullScreen) // Firefox
      document.mozCancelFullScreen();
    else if (document.msExitFullscreen) // IE or Edge
      document.msExitFullscreen();
  }

  function winClose() {
    top.window.open('about:blank', '_self').close();
    top.window.opener = self;
    top.self.close();
  }


  function is_reserve(reserve) {

    var params = {
      'csrfmiddlewaretoken': '{{ csrf_token }}',
      'reserve': reserve
    }

    $.ajax({
      url: "{% host_url 'reverse' host 'owner' %}",
      type: "POST",
      data: params,
      success: function (result) {
        alert('상태가 변경되었습니다.');
      },
      error: function (result) {
        alert("서버와의 연결이 끊어졌습니다.");
        hideLoading();
      }
    });

  }


</script>